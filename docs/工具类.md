# 工具类

```java
public class StreamUtil {
    public static <V, R> List<R> transform(List<V> list, Function<? super V, ? extends R> valueMapper) {
        return list.stream().filter(d -> d != null).map(valueMapper).collect(Collectors.toList());
    }

    public static <V, R> Set<R> transformToSet(List<V> list, Function<? super V, ? extends R> valueMapper) {
        return list.stream().filter(d -> d != null).map(valueMapper).collect(Collectors.toSet());
    }

    public static <K, V> Map<K, V> toMap(List<V> list, Function<? super V, ? extends K> keyMapper) {
        return list.stream().filter(d -> d != null).collect(Collectors.toMap(keyMapper, d -> d, (d1, d2) -> d1));
    }

    public static <K, V, R> Map<K, R> toMap(List<V> list, Function<? super V, ? extends K> keyMapper, Function<? super V, ? extends R> valueMapper) {
        return list.stream().filter(d -> d != null).collect(Collectors.toMap(keyMapper, valueMapper, (d1, d2) -> d1));
    }

    public static <K, V> Map<K, List<V>> group(List<V> list, Function<? super V, ? extends K> keyMapper) {
        return list.stream().filter(d -> d != null).collect(Collectors.groupingBy(keyMapper));
    }

    public static <K, V, R> Map<K, List<R>> group(List<V> list, Function<? super V, ? extends K> keyMapper, Function<? super V, ? extends R> valueMapper) {
        return list.stream().filter(d -> d != null).collect(Collectors.groupingBy(keyMapper, Collectors.mapping(valueMapper, Collectors.toList())));
    }

    public static <K, V, R> Map<K, Set<R>> groupToSet(List<V> list, Function<? super V, ? extends K> keyMapper, Function<? super V, ? extends R> valueMapper) {
        return list.stream().filter(d -> d != null).collect(Collectors.groupingBy(keyMapper, Collectors.mapping(valueMapper, Collectors.toSet())));
    }

    public static <T> Predicate<T> isDuplicate(Function<? super T, Object> keyExtractor) {
        Map<Object, Boolean> map = new ConcurrentHashMap<>();
        return t -> map.putIfAbsent(keyExtractor.apply(t), Boolean.TRUE) != null;
    }
}

```

```java
@Slf4j
public class ValidationHelper {
    private final static Validator validator = Validation.buildDefaultValidatorFactory().getValidator();

    private final static List<Class> basicTypeList = new ArrayList<>();

    static {
        basicTypeList.add(Boolean.class);
        basicTypeList.add(Byte.class);
        basicTypeList.add(Short.class);
        basicTypeList.add(Integer.class);
        basicTypeList.add(Long.class);
        basicTypeList.add(Character.class);
        basicTypeList.add(Double.class);
        basicTypeList.add(Float.class);
        basicTypeList.add(String.class);
        basicTypeList.add(BigDecimal.class);
        basicTypeList.add(AtomicLong.class);
        basicTypeList.add(AtomicInteger.class);
    }

    /**
     * 手动执行注解验证，效果等同于@Valid
     *
     */
    public static <T> String validator(T object) {
        return validator(object,false);
    }

    public static <T> String validator(T object, boolean fieldValidate) {
        String message = BaseResultType.SUCCESS.getDesc();
        Set<ConstraintViolation<T>> validResult = validator.validate(object);
        if (CollectionUtils.isNotEmpty(validResult)) {
            ConstraintViolation<T> violation = validResult.iterator().next();
            message = violation.getMessage();
        }
        if(fieldValidate) {
            Field[] fields = object.getClass().getDeclaredFields();
            for(Field field : fields) {
                Class clazz = field.getType();
                //如果属性是基本类型，对象校验时时已经验证过
                if(isBasicType(clazz)) {
                    continue;
                }
                //当属性为对象时，验证对象里面的validate
                Object obj = null;
                field.setAccessible(true);
                try {
                    obj = field.get(object);
                } catch (IllegalArgumentException | IllegalAccessException e) {
                    log.error(e.getMessage(),e);
                }
                if(obj != null) {
                    if(obj instanceof Collection) {
                        Collection collection = (Collection)obj;
                        message =  validator(collection,fieldValidate);
                    }else if(obj instanceof Map) {
                        Map map = (Map)obj;
                        message =  validator(map,fieldValidate);
                    }else {
                        message = validator(obj,fieldValidate);
                    }

                    if(!BaseResultType.SUCCESS.getDesc().equals(message)) {
                        return message;
                    }
                }
            }

        }

        return message;
    }

    public static boolean isBasicType(Class clazz) {
        return basicTypeList.contains(clazz);

    }


    /**
     * 检验集合
     *
     * @param collection
     * @return
     */
    public static <T> String validator(Collection<T> collection) {
        return validator(collection, false);
    }

    /**
     * 检验集合
     *
     * @param collection
    //	 * @param allowEmpty
     *            标记是否允许集合为空
     * @return
     * @throws IllegalAccessException
     * @throws IllegalArgumentException
     */
    public static <T> String validator(Collection<T> collection, boolean fieldValidate) {
        String result = "";
        for (T t : collection) {
            if (t instanceof Collection) {
                result = validator((Collection<?>) t, fieldValidate);
            } else if (t instanceof Map<?, ?>) {
                result = validator((Map<?, ?>) t, fieldValidate);
            } else {
                result = validator(t,fieldValidate);
                if(!BaseResultType.SUCCESS.getDesc().equals(result)) {
                    return result;
                }
            }
        }
        return result;
    }

    /**
     * 检验Map
     *
     * @param map
     * @return
     */
    public static <K, V> String validator(Map<K, V> map) {
        return validator(map, false);
    }

    /**
     * 检验Map
     *
     * @param map
    //	 * @param allowEmpty
     *            标记是否允许集合为空
     * @return
     */
    public static <K, V> String validator(Map<K, V> map, boolean fieldValidate) {
        String result = validator(map.values(), fieldValidate);
        return result;
    }

    /**
     * 往ConstraintValidatorContext写入指定错误信息
     *
     * @param context
     * @param message
     */
    public static void errorMessage(ConstraintValidatorContext context, String message) {
        context.disableDefaultConstraintViolation();
        context.buildConstraintViolationWithTemplate(message).addConstraintViolation();
    }
}

```

```java
@Data
@AllArgsConstructor
@AtomicTypeProperty
public class MatrixAdminBizResult<T> {
    /**
     * 错误码
     */
    private String resultCode;
    /**
     * 错误描述
     */
    private String resultDesc;
    /**
     * 数据
     */
    private T resultData;
    /**
     * 是否可重试
     */
    private Boolean canRetry;
    /**
     * tx id，使用skywalking trace id
     */
    private String txId;


    /**
     * 是否成功
     *
     * @return 是否成功
     */
    public boolean isSuccess() {
        return BizErrorCode.SUCCESS.getCode().equals(resultCode);
    }

    public static <T> MatrixAdminBizResult<T> successResult() {
        return successResult(null);
    }

    public static <T> MatrixAdminBizResult<T> successResult(T data) {
        BizErrorCode resultType = BizErrorCode.SUCCESS;
        return new MatrixAdminBizResult<>(resultType.getCode(), resultType.getDesc(), data, resultType.getCanRetry(), TraceContext.traceId());
    }

    public static <T> MatrixAdminBizResult<T> failResult() {
        return failResult(BizErrorCode.SYSTEM_ERROR);
    }

    public static <T> MatrixAdminBizResult<T> failResult(BizErrorCode resultType) {
        return failResult(resultType, null);
    }

    public static <T> MatrixAdminBizResult<T> failResult(BizErrorCode resultType, String errorMsg) {
        if (StringUtils.isBlank(errorMsg)) {
            errorMsg = resultType.getDesc();
        }
        return new MatrixAdminBizResult<>(resultType.getCode(), errorMsg, null, resultType.getCanRetry(), TraceContext.traceId());
    }

    public static <T> MatrixAdminBizResult<T> failResult(BizErrorCode resultType, T errorObject) {
        return new MatrixAdminBizResult<>(resultType.getCode(), resultType.getDesc(), errorObject, resultType.getCanRetry(), TraceContext.traceId());
    }
}

```